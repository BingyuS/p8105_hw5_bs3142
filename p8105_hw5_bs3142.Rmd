---
title: "p8105_hw5_bs3142"
author: "Bingyu Sun"
date: "11/3/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

library(tidyverse)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

## Problem 1

### Data import

```{r}
read_study = function(flnm) {
  read_csv(flnm) %>%
    mutate(filename = flnm)
}

study_data = 
  list.files(path = "./data",
             pattern = "*.csv",
             full.names = TRUE) %>%
  map_df(~read_study(.x))
```

### Data tidying

```{r}
tidy_study =
  study_data %>%
  mutate(filename = str_replace_all(filename, c("^./data/" = "", ".csv$" = ""))) %>%
  separate(filename, into = c("treatment", "id"), sep = "_") %>%
  mutate(treatment = str_replace_all(treatment, c("con" = "control", "exp" = "experiment"))) %>%
  gather(key = week, value = value, week_1:week_8) %>%
  mutate(week = str_replace(week, "^week_", ""))
```

### Spaghetti plot

```{r, dpi = 300}
tidy_study %>%
  mutate(week = as.numeric(week)) %>%
  group_by(treatment, id) %>% 
  ggplot(aes(x = week, y = value, color = id)) +
  geom_line() +
  facet_grid(~treatment) +
  labs(
    title = "Observations of Each Subject Over Time by Treatment"
  ) +
  viridis::scale_color_viridis(
    name = "Subject ID",
    discrete = TRUE
  ) +
  scale_x_continuous(breaks = c(1:8))
```

Comment:

In general, there is an increase in performance over time in the experimental group comparing to the control group, suggesting a positive correlation between treatment and participants' performance.

## Problem 2

### Data import

```{r}
cases_raw = read_csv("./homicide-data.csv")
```

### Data manipulation

```{r}
cases_tidy =
  cases_raw %>%
  mutate(city_state = str_c(city, ",", state)) %>% #get new variable city_state
  mutate(disposition = str_replace_all(disposition, c("Closed without arrest" = "Unsolved", "Open/No arrest" = "Unsolved"))) #combine two categories to one category called unsolved
```

#### Q & A

**1. Summarize within cities to obtain the total number of homicides, and the number of unsolved homicides (those for which the disposition is “Closed without arrest” or “Open/No arrest”).**

```{r}
cases_nest =
  cases_tidy %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    n_total = map(.x = data, ~ .x %>% 
                    pull(disposition) %>%
                    length()),
    n_unsolved = map(.x = data, ~ .x %>%
                       filter(disposition == "Unsolved") %>%
                       pull(disposition) %>%
                       length())
  ) %>%
  select(-data)

cases_nest %>%
  knitr::kable(digits = 0)
```

**2. For the city of Baltimore, MD, use the prop.test function to estimate the proportion of homicides that are unsolved; save the output of prop.test as an R object, apply the broom::tidy to this object and pull the estimated proportion and confidence intervals from the resulting tidy dataframe.**

```{r}
bal_result = prop.test(cases_nest$n_unsolved[[3]], cases_nest$n_total[[3]])

broom::tidy(bal_result) %>%
  pull(estimate)

broom::tidy(bal_result) %>%
  pull(conf.low)

broom::tidy(bal_result) %>%
  pull(conf.high)
```

**3. Run prop.test for each of the cities in your dataset, and extract both the proportion of unsolved homicides and the confidence interval for each. Do this within a “tidy” pipeline, making use of purrr::map, purrr::map2, list columns and unnest as necessary to create a tidy dataframe with estimated proportions and CIs for each city.**

```{r}

```


